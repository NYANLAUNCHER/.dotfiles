# Settings:
set shell bash
set shellopts '-eu'
set hidden true
set scrolloff 2
set sixel true

# Keymaps:
map q quit
map Q quit-cd
map <enter> shell
map ` !true #show the result of execution of previous commands

# Opening files
map l open # uses $OPENER
map e edit # uses $EDITOR or nvim
map C edit-config

## File management
map x cut
map y copy
map D delete #trashes the file
map R rename
map u undo
map T push :mkfiles<space>

## Shortcuts
map x explore
map gh cd ~
map gd cd ~/tmp
map gs cd ~/src
map gn cd ~/notes
map gm cd ~/media
map gf cd ~/files


# Commands: (see 'https://pkg.go.dev/github.com/gokcehan/lf#hdr-Prefixes')
## Builtin Commands:
cmd open &{{
    if [ -f "$f" ]; then
        $OPENER "$f"
    fi
}}
cmd paste &{{
    set -- $(cat ~/.local/share/lf/files)
    mode="$1"
    shift
    case "$mode" in
        copy) cp -rn -- "$@" .;;
        move) mv -n -- "$@" .;;
    esac
    rm "$XDG_DATA_HOME/lf/files"
    lf -remote "send $id clear"
}}
# Just trashes file, to hard delete file run 'rm $f' in shell
cmd delete &{{
    set -f
    if command -v trash; then
        trash -r $fx
        lf -remote "send $id echomsg \"trashed \`$fx\`\""
    else
        ! [ -d "$XDG_DATA_HOME/trash" ] && mkdir "$XDG_DATA_HOME/trash"
        mv $fx "$XDG_DATA_HOME/trash"
        lf -remote "send $id echomsg \"moved \`$fx\` to \`$XDG_DATA_HOME/trash\`\""
    fi
}}
cmd rename %{{
    read -rn1 -p "Are you sure you want to rename\`$f\`? [y/N]: "
    [ -e $1 ] && printf "file exists" || mv $f $1
}}

## Custom Commands:
cmd quit-cd ${{
    export LF_PWD="$PWD"
    lf -remote "send quit"
    cd "$LF_PWD"
}}
cmd edit ${{
    #lf-set-title "lf: e ${f/#$HOME/\~}"
    $EDITOR "$f"
}}
cmd edit-config ${{
    #lf-set-title "lf: $EDITOR lfrc"
    $EDITOR $LFRC
    lf -remote "send $id source $LFRC"
}}
cmd mkfiles %{{
    for file in "$@";do
        touch $file
    done
}}
cmd mkdirs %{{
    for dir in "$@";do
        mkdir -p $dir
    done
}}
# undo things like trashed files
cmd undo &{{
    lf -remote "send $id unselect"
}}
# quickly find directories and files
cmd explore ${{
}}

## Events
cmd on-cd &{{
    # display git repository status in your prompt
    source /usr/share/git/completion/git-prompt.sh
    GIT_PS1_SHOWDIRTYSTATE=auto
    GIT_PS1_SHOWSTASHSTATE=auto
    GIT_PS1_SHOWUNTRACKEDFILES=auto
    GIT_PS1_SHOWUPSTREAM=auto
    GIT_PS1_COMPRESSSPARSESTATE=auto
    git=$(__git_ps1 " [GIT BRANCH:> %s]") || true
    fmt="\033[32;1m%u@%h\033[0m:\033[34;1m%w\033[0m\033[33;1m$git\033[0m"
    lf -remote "send $id set promptfmt \"$fmt\""
    # set term title
    #lf-set-title "lf: ${PWD/#$HOME/\~}"
}}
on-cd

